#!/bin/sh
set -e

# Make pacman and yay colorful and adds eye candy on the progress bar because why not.
sudo sed -i "s/^#Color$/Color/" /etc/pacman.conf
grep -q "^ILoveCandy" /etc/pacman.conf || sudo sed -i "/#VerbosePkgLists/a ILoveCandy" /etc/pacman.conf
grep -q "^ParallelDownloads" /etc/pacman.conf || sudo sed -i "/#VerbosePkgLists/a ParallelDownloads = 5" /etc/pacman.conf

# set golang vars before installing anything for go
export GOPATH="${XDG_DATA_HOME:-$HOME/.local/share}/go"
export GOBIN="${GOPATH}/bin"

sudo pacman -Syuu --noconfirm

# ====================================
# Install packages
# ====================================

# dig is part of bind-tools
# hostname is part of inetutils
sudo pacman -S --noconfirm --needed \
                alacritty \
                base-devel \
                bc \
                bind-tools \
                chromium \
                curl \
                dunst \
                feh \
                firefox-developer-edition \
                fzf \
                gdu \
                git-delta \
                gnome-themes-extra \
                go \
                htop \
                i3-gaps \
                i3lock \
                inetutils \
                jq \
                k9s \
                kubectl \
                kubectx \
                libnotify \
                libreoffice \
                maim \
                man-db \
                neovim \
                net-tools \
                nm-connection-editor \
                noto-fonts-cjk \
                ntfs-3g \
                openssh \
                picom \
                pulseaudio-alsa \
                pulsemixer \
                pyenv \
                python-pip \
                python-poetry \
                python-pywal \
                python3 \
                ripgrep \
                rofi \
                scrot \
                slock \
                sxiv \
                thunar \
                tmux \
                ttf-fira-code \
                ttf-iosevka-nerd \
                udisks2 \
                unclutter \
                unzip \
                vlc \
                wget \
                xclip \
                xdotool \
                xorg-mkfontscale \
                xorg-server \
                xorg-xinit \
                xorg-xrandr \
                xorg-xset \
                yarn \
                zathura \
                zathura-pdf-mupdf \
                zip \
                zsh \
                zsh-syntax-highlighting

if pacman -Qs yay > /dev/null ; then
    echo "Yay is already installed, moving on..."
else
    pushd /tmp
    rm -rf yay
    git clone https://aur.archlinux.org/yay.git
    pushd yay
    makepkg -si --noconfirm
    popd
    rm -rf yay
    popd
fi

yay -S --needed --removemake --nocleanmenu --nodiffmenu --noeditmenu --noconfirm \
                bfg \
                bitwarden-cli \
                catppuccin-gtk-theme \
                dive \
                gotop \
                insomnia-bin \
                ttf-icomoon-feather \
                lazygit \
                lf \
                mullvad-vpn-bin \
                nerd-fonts-jetbrains-mono \
                nvm \
                polybar \
                spicetify-cli \
                spotify \
                tela-icon-theme-bin \
                tmuxinator \
                zsh-fast-syntax-highlighting


# ====================================
# Polybar font
# ====================================


# configure ssh agent
systemctl --user enable --now ssh-agent.service

# configure touchpad settings
if [[ $(hostname -s) = asgard ]]; then
sudo tee /etc/X11/xorg.conf.d/30-touchpad.conf > /dev/null << EOF
Section "InputClass"
        Identifier "libinput touchpad catchall"
        MatchIsTouchpad "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
        Option "NaturalScrolling" "true"
        Option "Tapping" "on"
        Option "TappingButtonMap" "lrm"
EndSection
EOF
fi

# Disable sudo password prompt timeout
sudo grep -xq "Defaults passwd_timeout=0" /etc/sudoers || sudo sh -c 'echo "Defaults passwd_timeout=0" >> /etc/sudoers'

# must be run once to configure nvm
source /usr/share/nvm/init-nvm.sh

# create folder for ZSH history
mkdir -p "${XDG_CACHE_HOME:-$HOME/.cache}/zsh"

echo "=============="
echo "==== DONE ===="
echo "=============="
echo "$ chsh -s /bin/zsh"
echo "$ startx"
echo "$ feh --bg-fill ~/.config/wallpaper.png"
